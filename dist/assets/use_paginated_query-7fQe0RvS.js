import{l as x,r as p,m as I,n as M,o as L,C as E}from"./index-_3OQfKDT.js";const h=(i,n,t)=>s=>{const r={...s.queries},d=s.nextPageKey,a=s.nextPageKey+1,l=s.nextPageKey+2;r[d]={query:s.query,args:{...s.args,paginationOpts:{...s.queries[i].args.paginationOpts,endCursor:n}}},r[a]={query:s.query,args:{...s.args,paginationOpts:{...s.queries[i].args.paginationOpts,cursor:n,endCursor:t}}};const c={...s.ongoingSplits};return c[i]=[d,a],{...s,nextPageKey:l,queries:r,ongoingSplits:c}},Q=i=>n=>{const t=n.ongoingSplits[i];if(t===void 0)return n;const s={...n.queries};delete s[i];const r={...n.ongoingSplits};delete r[i];let d=n.pageKeys.slice();const a=n.pageKeys.findIndex(l=>l===i);return a>=0&&(d=[...n.pageKeys.slice(0,a),...t,...n.pageKeys.slice(a+1)]),{...n,queries:s,pageKeys:d,ongoingSplits:r}};function D(i,n,t){const{user:s}=w(i,n,t);return s}const R=Symbol("includePageKeys"),j=Symbol("page");function w(i,n,t){if(typeof t?.initialNumItems!="number"||t.initialNumItems<0)throw new Error(`\`options.initialNumItems\` must be a positive number. Received \`${t?.initialNumItems}\`.`);const s=n==="skip",r=s?{}:n,d=x(i),a=p.useMemo(()=>()=>{const e=J();return{query:i,args:r,id:e,nextPageKey:1,pageKeys:s?[]:[0],queries:s?{}:{0:{query:i,args:{...r,paginationOpts:{numItems:t.initialNumItems,cursor:null,id:e}}}},ongoingSplits:{},skip:s}},[JSON.stringify(I(r)),d,t.initialNumItems,s]),[l,c]=p.useState(a);let u=l;(x(i)!==x(l.query)||JSON.stringify(I(r))!==JSON.stringify(I(l.args))||s!==l.skip)&&(u=a(),c(u));const P=M().logger,y=L(u.queries),q=t[R]??!1,[O,f]=p.useMemo(()=>{let e;const m=[];for(const g of u.pageKeys){if(e=y[g],e===void 0)break;if(e instanceof Error){if(e.message.includes("InvalidCursor")||e instanceof E&&typeof e.data=="object"&&e.data?.isConvexSystemError===!0&&e.data?.paginationError==="InvalidCursor")return P.warn("usePaginatedQuery hit error, resetting pagination state: "+e.message),c(a),[[],void 0];throw e}const o=u.ongoingSplits[g];if(o!==void 0?y[o[0]]!==void 0&&y[o[1]]!==void 0&&c(Q(g)):e.splitCursor&&(e.pageStatus==="SplitRecommended"||e.pageStatus==="SplitRequired"||e.page.length>t.initialNumItems*2)&&c(h(g,e.splitCursor,e.continueCursor)),e.pageStatus==="SplitRequired")return[m,void 0];m.push(...q?e.page.map(K=>({...K,[j]:g.toString()})):e.page)}return[m,e]},[y,u.pageKeys,u.ongoingSplits,t.initialNumItems,a,P,q]),b=p.useMemo(()=>{if(f===void 0)return u.nextPageKey===1?{status:"LoadingFirstPage",isLoading:!0,loadMore:g=>{}}:{status:"LoadingMore",isLoading:!0,loadMore:g=>{}};if(f.isDone)return{status:"Exhausted",isLoading:!1,loadMore:g=>{}};const e=f.continueCursor;let m=!1;return{status:"CanLoadMore",isLoading:!1,loadMore:g=>{m||(m=!0,c(o=>{const K=[...o.pageKeys,o.nextPageKey],C={...o.queries};return C[o.nextPageKey]={query:o.query,args:{...o.args,paginationOpts:{numItems:g,cursor:e,id:o.id}}},{...o,nextPageKey:o.nextPageKey+1,pageKeys:K,queries:C}}))}}},[f,u.nextPageKey]);return{user:{results:O,...b},internal:{state:u}}}let N=0;function J(){return N++,N}export{D as u};
